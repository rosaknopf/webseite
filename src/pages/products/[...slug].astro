---
import { type CollectionEntry, getCollection } from "astro:content";
import { Image, getImage } from "astro:assets";
import Layout from "../../layouts/Layout.astro";
import BuyButton from "../../components/BuyButton.astro";
import { siteConfig } from "../../data/siteConfig";

export async function getStaticPaths() {
    const products = await getCollection("products");
    return products.map((product) => ({
        params: { slug: product.slug },
        props: product,
    }));
}
type Props = CollectionEntry<"products">;

const product = Astro.props;
const { Content } = await product.render();

// Use dynamic OG image with Price & CTA
const ogImage = new URL(
    `/og/products/${product.slug}.png`,
    siteConfig.siteUrl,
).toString();

// Keep heroImage jpg generaton? No, we use the dynamic one now.
---

<Layout
    title={`${product.data.title} | Shop`}
    description={product.data.description}
    image={ogImage}
    imageWidth={1200}
    imageHeight={630}
>
    <div class="max-w-6xl mx-auto px-4 py-12">
        <div class="grid md:grid-cols-2 gap-12">
            <!-- Product Image(s) -->
            <!-- Product Image(s) -->
            <div class="space-y-4">
                <div class="pswp-gallery" id="my-gallery">
                    <div
                        class="aspect-square bg-rose-100/60 rounded-3xl overflow-hidden border border-rose-200 relative group cursor-pointer"
                    >
                        {
                            product.data.heroImage ? (
                                <a
                                    href={product.data.heroImage.src}
                                    data-pswp-width={
                                        product.data.heroImage.width
                                    }
                                    data-pswp-height={
                                        product.data.heroImage.height
                                    }
                                    target="_blank"
                                    class="block w-full h-full"
                                >
                                    <Image
                                        src={product.data.heroImage}
                                        alt={product.data.title}
                                        class="w-full h-full object-cover transition duration-500 group-hover:scale-105"
                                        width={1024}
                                        densities={[1.5, 2]}
                                    />
                                </a>
                            ) : (
                                <div class="w-full h-full flex items-center justify-center text-rose-200">
                                    <span class="text-8xl">ðŸ§¶</span>
                                </div>
                            )
                        }
                        {
                            product.data.isSoldOut && (
                                <div class="absolute inset-0 bg-white/30 backdrop-blur-sm flex items-center justify-center z-10 pointer-events-none">
                                    <span class="bg-rose-900 text-white px-6 py-3 font-bold uppercase tracking-widest text-xl rounded-full transform -rotate-12 shadow-2xl border-4 border-white">
                                        Verkauft
                                    </span>
                                </div>
                            )
                        }
                    </div>

                    {/* Additional Gallery Images */}
                    {
                        product.data.gallery &&
                            product.data.gallery.length > 0 && (
                                <div class="grid grid-cols-4 gap-4 mt-4">
                                    {product.data.gallery.map((item, index) => (
                                        <a
                                            href={item.image.src}
                                            data-pswp-width={item.image.width}
                                            data-pswp-height={item.image.height}
                                            target="_blank"
                                            class="aspect-square rounded-xl overflow-hidden border border-rose-100 block hover:opacity-90 transition"
                                        >
                                            <Image
                                                src={item.image}
                                                alt={`Galeriebild ${index + 1}`}
                                                class="w-full h-full object-cover"
                                                width={300}
                                                height={300}
                                            />
                                        </a>
                                    ))}
                                </div>
                            )
                    }
                </div>
            </div>

            <link
                rel="stylesheet"
                href="https://unpkg.com/photoswipe@5.4.3/dist/photoswipe.css"
            />

            <script>
                import PhotoSwipeLightbox from "photoswipe/lightbox";
                import "photoswipe/style.css";

                const lightbox = new PhotoSwipeLightbox({
                    gallery: "#my-gallery",
                    children: "a",
                    pswpModule: () => import("photoswipe"),
                });
                lightbox.init();
            </script>

            <!-- Product Info -->
            <div class="flex flex-col">
                <div class="mb-auto">
                    <h1
                        class="text-4xl font-serif font-bold text-rose-950 mb-2"
                    >
                        {product.data.title}
                    </h1>
                    <div
                        class="text-3xl font-bold text-rose-600 mb-6 whitespace-nowrap"
                    >
                        {
                            product.data.price % 1 === 0
                                ? product.data.price
                                : product.data.price.toFixed(2)
                        } â‚¬
                    </div>

                    <div class="prose prose-gray text-gray-800 mb-8">
                        <Content />
                    </div>
                </div>

                <div
                    class="bg-rose-100/60 p-6 rounded-2xl border border-rose-200 shadow-sm sticky bottom-4 md:static"
                >
                    <BuyButton
                        stripeLink={product.data.stripeLink}
                        price={product.data.price}
                        isSoldOut={product.data.isSoldOut}
                        isUnique={product.data.isUnique}
                    />
                </div>
            </div>
        </div>
    </div>
</Layout>
