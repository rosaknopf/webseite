---
import Layout from "../../layouts/Layout.astro";
import { getCollection } from "astro:content";
import { Image } from "astro:assets";
import { siteConfig } from "../../data/siteConfig";

const products = (await getCollection("products")).sort((a, b) => {
    // Sort logic: Available first, then by title/date
    if (a.data.isSoldOut === b.data.isSoldOut) {
        return 0; // Keep original order or sort by date if added
    }
    return a.data.isSoldOut ? 1 : -1;
});
---

<Layout
    title={`Shop | ${siteConfig.title}`}
    description="Handgemachte Unikate fÃ¼r Sie."
>
    <section class="max-w-6xl mx-auto py-12">
        <div class="text-center mb-16">
            <h1 class="text-4xl md:text-5xl font-serif text-rose-950 mb-4">
                Unser Shop
            </h1>
            <p class="text-rose-700/80 max-w-2xl mx-auto">
                Jedes StÃ¼ck ein Unikat. Mit Liebe handgefertigt.
            </p>
        </div>

        <div class="flex justify-end mb-8 relative z-10">
            <div class="relative inline-block text-left">
                <select
                    id="sort-select"
                    class="block w-full pl-3 pr-10 py-2 text-base border-rose-200 focus:outline-none focus:ring-rose-500 focus:border-rose-500 sm:text-sm rounded-md text-rose-900 bg-white shadow-sm cursor-pointer"
                >
                    <option value="newest">Neuheiten</option>
                    <option value="price-asc">Preis aufsteigend</option>
                    <option value="price-desc">Preis absteigend</option>
                </select>
            </div>
        </div>

        <div
            id="product-grid"
            class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8"
        >
            {
                products.map((product) => (
                    <a
                        href={`/products/${product.slug}/`}
                        class={`product-card group block bg-white rounded-2xl overflow-hidden shadow-sm hover:shadow-xl transition border border-rose-50 flex flex-col h-full ${product.data.isSoldOut ? "opacity-70 grayscale-[0.5]" : ""}`}
                        data-price={product.data.price}
                        data-date={
                            product.data.pubDate
                                ? new Date(product.data.pubDate).getTime()
                                : 0
                        }
                    >
                        <div class="aspect-square overflow-hidden bg-rose-100 relative">
                            {product.data.heroImage ? (
                                <Image
                                    src={product.data.heroImage}
                                    alt={product.data.title}
                                    class="w-full h-full object-cover transform group-hover:scale-105 transition duration-500"
                                    width={720}
                                    densities={[1.5, 2]}
                                />
                            ) : (
                                <div class="w-full h-full flex items-center justify-center text-rose-300 bg-rose-50">
                                    <span class="text-6xl opacity-20">ðŸ§¶</span>
                                </div>
                            )}

                            {product.data.isSoldOut && (
                                <div class="absolute inset-0 bg-white/50 backdrop-blur-sm flex items-center justify-center">
                                    <span class="bg-rose-900 text-white px-4 py-2 font-bold uppercase tracking-widest text-sm rounded-full transform -rotate-12 shadow-xl border-2 border-white">
                                        Verkauft
                                    </span>
                                </div>
                            )}
                            {!product.data.isSoldOut &&
                                product.data.isUnique && (
                                    <div class="absolute top-4 right-4 bg-white/90 text-rose-600 px-3 py-1 text-xs font-bold uppercase tracking-wider rounded-full shadow-sm">
                                        Unikat
                                    </div>
                                )}
                        </div>
                        <div class="p-6 flex-grow flex flex-col">
                            <div class="flex justify-between items-start mb-2">
                                <h2 class="text-xl font-serif font-bold text-rose-900 group-hover:text-rose-600 transition">
                                    {product.data.title}
                                </h2>
                                <span class="font-bold text-rose-800 bg-rose-50 px-2 py-1 rounded text-sm whitespace-nowrap">
                                    {product.data.price % 1 === 0
                                        ? product.data.price
                                        : product.data.price.toFixed(2)}{" "}
                                    â‚¬
                                </span>
                            </div>
                            <p class="text-rose-700/80 text-sm line-clamp-2 mb-4 flex-grow">
                                {product.data.description}
                            </p>
                            <span class="text-center block w-full py-2 rounded-lg bg-rose-50 text-rose-600 font-medium group-hover:bg-rose-600 group-hover:text-white transition">
                                {product.data.isSoldOut
                                    ? "Details ansehen"
                                    : "Zum Produkt"}
                            </span>
                        </div>
                    </a>
                ))
            }
        </div>
    </section>

    <script>
        const select = document.getElementById(
            "sort-select",
        ) as HTMLSelectElement;
        const grid = document.getElementById("product-grid");

        if (select && grid) {
            select.addEventListener("change", () => {
                const sortValue = select.value;
                const products = Array.from(
                    grid.children,
                ) as HTMLAnchorElement[];

                products.sort((a, b) => {
                    const priceA = parseFloat(a.dataset.price || "0");
                    const priceB = parseFloat(b.dataset.price || "0");
                    const dateA = parseInt(a.dataset.date || "0");
                    const dateB = parseInt(b.dataset.date || "0");

                    if (sortValue === "price-asc") {
                        return priceA - priceB;
                    } else if (sortValue === "price-desc") {
                        return priceB - priceA;
                    } else if (sortValue === "newest") {
                        return dateB - dateA;
                    }
                    return 0;
                });

                // Re-append in new order
                products.forEach((product) => grid.appendChild(product));
            });
        }
    </script>
</Layout>
