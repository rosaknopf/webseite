---
import Layout from "../../layouts/Layout.astro";
import { getCollection } from "astro:content";
import { Image } from "astro:assets";
import { siteConfig } from "../../data/siteConfig";

const allProducts = await getCollection("products");
const pinnedProducts = allProducts
    .filter((p) => p.data.isPinned)
    .sort((a, b) => new Date(b.data.pubDate).valueOf() - new Date(a.data.pubDate).valueOf());

const featuredProduct = pinnedProducts.length > 0 ? pinnedProducts[0] : null;

const products = allProducts
    .filter((p) => !featuredProduct || p.slug !== featuredProduct.slug)
    .sort((a, b) => {
        if (a.data.isSoldOut === b.data.isSoldOut) {
            return new Date(b.data.pubDate).valueOf() - new Date(a.data.pubDate).valueOf();
        }
        return a.data.isSoldOut ? 1 : -1;
    });
---

<Layout
    title={`Shop | ${siteConfig.title}`}
    description="Handgemachte Unikate fÃ¼r Sie."
>
    <section class="max-w-6xl mx-auto py-12">
        <div class="text-center mb-16">
            <h1 class="text-4xl md:text-5xl font-serif text-rose-950 mb-4">
                Unser Shop
            </h1>
            <p class="text-gray-600 max-w-2xl mx-auto">
                Jedes StÃ¼ck ein Unikat. Mit Liebe handgefertigt.
            </p>
        </div>

        <div class="flex justify-end mb-8 relative z-10">
            <div class="relative inline-block text-left">
                <select
                    id="sort-select"
                    class="block w-full pl-3 pr-10 py-2 text-base border-gray-200 focus:outline-none focus:ring-rose-500 focus:border-rose-500 sm:text-sm rounded-md text-gray-800 bg-white shadow-sm cursor-pointer"
                >
                    <option value="newest">Neuheiten</option>
                    <option value="price-asc">Preis aufsteigend</option>
                    <option value="price-desc">Preis absteigend</option>
                </select>
            </div>
        </div>

        </div>

        {featuredProduct && (
            <div class="mb-16">
                <div class="relative w-full bg-white rounded-3xl border border-rose-200 shadow-xl overflow-hidden flex flex-col md:flex-row group md:h-[420px] lg:h-[460px]">
                    <div class="w-full md:w-1/2 aspect-square md:aspect-auto md:h-full bg-rose-50 overflow-hidden relative">
                        {featuredProduct.data.gallery && featuredProduct.data.gallery.length > 0 ? (
                            <div class="flex overflow-x-auto snap-x snap-mandatory h-full scrollbar-hide hide-scrollbar w-full">
                                <div class="w-full shrink-0 h-full snap-start relative">
                                    <Image
                                        src={featuredProduct.data.heroImage || featuredProduct.data.gallery[0].image}
                                        alt={featuredProduct.data.title}
                                        class="w-full h-full object-cover"
                                        width={1024}
                                        densities={[1.5, 2]}
                                    />
                                </div>
                                {featuredProduct.data.gallery.map((item) => (
                                    <div class="w-full shrink-0 h-full snap-start relative">
                                        <Image
                                            src={item.image}
                                            alt={featuredProduct.data.title}
                                            class="w-full h-full object-cover"
                                            width={1024}
                                            densities={[1.5, 2]}
                                        />
                                    </div>
                                ))}
                            </div>
                        ) : (
                            featuredProduct.data.heroImage ? (
                                <Image
                                    src={featuredProduct.data.heroImage}
                                    alt={featuredProduct.data.title}
                                    class="w-full h-full object-cover"
                                    width={1024}
                                    densities={[1.5, 2]}
                                />
                            ) : (
                                <div class="w-full h-full flex items-center justify-center text-rose-300">
                                    <span class="text-6xl opacity-20">ðŸ§¶</span>
                                </div>
                            )
                        )}
                        <div class="absolute top-4 left-4 right-4 flex justify-between pointer-events-none">
                            <div class="bg-rose-600 text-white px-4 py-1 text-sm font-bold uppercase tracking-wider rounded-full shadow-md backdrop-blur-md">
                                Highlight
                            </div>
                            {featuredProduct.data.isUnique && (
                                <div class="bg-white/90 text-rose-600 px-4 py-1 text-sm font-bold uppercase tracking-wider rounded-full shadow-md backdrop-blur-md">
                                    Unikat
                                </div>
                            )}
                        </div>
                        {featuredProduct.data.isSoldOut && (
                            <div class="absolute inset-0 bg-white/50 backdrop-blur-sm flex items-center justify-center pointer-events-none">
                                <span class="bg-rose-900 text-white px-6 py-3 font-bold uppercase tracking-widest text-xl rounded-full transform -rotate-12 shadow-2xl border-4 border-white">
                                    Verkauft
                                </span>
                            </div>
                        )}
                        {featuredProduct.data.gallery && featuredProduct.data.gallery.length > 0 && (
                            <div class="absolute bottom-4 left-0 right-0 flex justify-center gap-2 pointer-events-none opacity-50">
                                <span class="bg-black/50 text-white text-xs px-2 py-1 rounded-full backdrop-blur-md">Mehr Bilder &rarr;</span>
                            </div>
                        )}
                    </div>
                    
                    <div class="w-full md:w-1/2 p-8 md:p-12 flex flex-col justify-center relative">
                        <div class="flex justify-between items-start mb-4">
                            <h2 class="text-3xl md:text-4xl font-serif font-bold text-rose-950">
                                {featuredProduct.data.title}
                            </h2>
                            <span class="font-bold text-gray-800 bg-gray-100 px-3 py-1 rounded-lg text-lg whitespace-nowrap ml-4 border border-gray-200">
                                {featuredProduct.data.price % 1 === 0 ? featuredProduct.data.price : featuredProduct.data.price.toFixed(2)} â‚¬
                            </span>
                        </div>
                        <p class="text-gray-600 text-base md:text-lg mb-8 line-clamp-4">
                            {featuredProduct.data.description}
                        </p>
                        
                        <a 
                            href={`/products/${featuredProduct.slug}/`} 
                            class="inline-flex justify-center items-center w-full py-4 rounded-xl bg-rose-600 text-white font-bold text-lg hover:bg-rose-700 transition shadow-md hover:shadow-xl hover:-translate-y-1"
                        >
                            {featuredProduct.data.isSoldOut ? "Details ansehen" : "Zum Produkt"}
                        </a>
                    </div>
                </div>
            </div>
        )}

        <style>
            .hide-scrollbar::-webkit-scrollbar {
                display: none;
            }
            .hide-scrollbar {
                -ms-overflow-style: none;
                scrollbar-width: none;
            }
        </style>

        <div
            id="product-grid"
            class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8"
        >
            {
                products.map((product) => (
                    <a
                        href={`/products/${product.slug}/`}
                        class={`product-card group block bg-white rounded-2xl overflow-hidden shadow-sm hover:shadow-xl transition border border-rose-100 flex flex-col h-full ${product.data.isSoldOut ? "opacity-70 grayscale-[0.5]" : ""}`}
                        data-price={product.data.price}
                        data-date={
                            product.data.pubDate
                                ? new Date(product.data.pubDate).getTime()
                                : 0
                        }
                    >
                        <div class="aspect-square overflow-hidden bg-rose-100/60 relative">
                            {product.data.heroImage ? (
                                <Image
                                    src={product.data.heroImage}
                                    alt={product.data.title}
                                    class="w-full h-full object-cover transform group-hover:scale-105 transition duration-500"
                                    width={720}
                                    densities={[1.5, 2]}
                                />
                            ) : (
                                <div class="w-full h-full flex items-center justify-center text-gray-300 bg-rose-50/50">
                                    <span class="text-6xl opacity-20">ðŸ§¶</span>
                                </div>
                            )}

                            {product.data.isSoldOut && (
                                <div class="absolute inset-0 bg-white/50 backdrop-blur-sm flex items-center justify-center">
                                    <span class="bg-rose-900 text-white px-4 py-2 font-bold uppercase tracking-widest text-sm rounded-full transform -rotate-12 shadow-xl border-2 border-white">
                                        Verkauft
                                    </span>
                                </div>
                            )}
                            {!product.data.isSoldOut &&
                                product.data.isUnique && (
                                    <div class="absolute top-4 right-4 bg-white/90 text-rose-600 px-3 py-1 text-xs font-bold uppercase tracking-wider rounded-full shadow-sm">
                                        Unikat
                                    </div>
                                )}
                        </div>
                        <div class="p-6 flex-grow flex flex-col">
                            <div class="flex justify-between items-start mb-2">
                                <h2 class="text-xl font-serif font-bold text-rose-950 group-hover:text-rose-500 transition">
                                    {product.data.title}
                                </h2>
                                <span class="font-bold text-gray-800 bg-gray-100 px-2 py-1 rounded text-sm whitespace-nowrap">
                                    {product.data.price % 1 === 0
                                        ? product.data.price
                                        : product.data.price.toFixed(2)}{" "}
                                    â‚¬
                                </span>
                            </div>
                            <div class="flex-grow mb-4 flex flex-col">
                                <p class="text-gray-600 text-sm line-clamp-2">
                                    {product.data.description}
                                </p>
                            </div>
                            <span class="text-center block w-full py-2 rounded-lg bg-rose-100/60 text-rose-950 font-medium group-hover:bg-rose-500 group-hover:text-white transition">
                                {product.data.isSoldOut
                                    ? "Details ansehen"
                                    : "Zum Produkt"}
                            </span>
                        </div>
                    </a>
                ))
            }
        </div>
    </section>

    <script>
        const select = document.getElementById(
            "sort-select",
        ) as HTMLSelectElement;
        const grid = document.getElementById("product-grid");

        if (select && grid) {
            select.addEventListener("change", () => {
                const sortValue = select.value;
                const products = Array.from(
                    grid.children,
                ) as HTMLAnchorElement[];

                products.sort((a, b) => {
                    const priceA = parseFloat(a.dataset.price || "0");
                    const priceB = parseFloat(b.dataset.price || "0");
                    const dateA = parseInt(a.dataset.date || "0");
                    const dateB = parseInt(b.dataset.date || "0");

                    if (sortValue === "price-asc") {
                        return priceA - priceB;
                    } else if (sortValue === "price-desc") {
                        return priceB - priceA;
                    } else if (sortValue === "newest") {
                        return dateB - dateA;
                    }
                    return 0;
                });

                // Re-append in new order
                products.forEach((product) => grid.appendChild(product));
            });
        }
    </script>
</Layout>
